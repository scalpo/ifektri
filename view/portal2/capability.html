<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/styles/default.min.css">

    <title>ifektri capability</title>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

    <h1 id="headingCapability" class="mt-4">Capability</h1>
    
    <div class="card mb-4">
        <div class="card-header" id="capabilitySchema"></div>
        <div class="card-body">
            <div class="container-fluid">
              <div class="row">
                <div class="col-md-12">
                  <div class="container">
                    <div id="chart" style="display: none"></div><br/>
                  </div>
                </div>
                <!-- <div class="col-md-6">
                  <div class="container">
                    <div id="stepDescription">                    
                    </div>
                  </div>
              </div> -->
            </div>
        </div>
        <!-- <div class="card-footer">
            aaa
        </div> -->
    </div>
    <div class="card mb-4">
        <div class="card-body" id="explainCapability"></div>
    </div>
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.13.0/flowchart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.1/highlight.min.js"></script>
    <!-- <script src="../ifektri.js"></script> -->
    <script>
    //get queryString param by name
    var urlParam = function(name) {
      var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
      if (results == null) {
        return 0;
      }
      return results[1] || 0;
    }
      
    var methods = {
      authenticate: '',
      validateRequest: '',
      authorize: '',
      processInstruction: ''
    };

    var describeNode = function(description) {
      $('#stepDescription').html('<code><pre>&nbsp;&nbsp;' + description.replace('\n', '<br />') + '</pre></code>');
      hljs.highlightBlock($('#stepDescription code pre')[0]);
    }

    var clickNode = function(step) {
      return;
      switch (step) {
        case 'newRequest':
          describeNode('A new ifektri request arrives');
          break;
        case 'identify':
          describeNode(methods.authenticate);
          break;
        case 'validate':
          describeNode(methods.validateRequest);
          break;
        case 'isValid':
          describeNode('if an invalid request was sent');
          break;
        case 'badRequest':
          describeNode('400/404/503');
          break;
        case 'authorize':
          describeNode(methods.authorize);
          break;
        case 'isAuthorized':
          describeNode('if requester is allowed to call this ability');
          break;
        case 'unauthorizedRequest':
          describeNode('401');
          break;
        case 'operate':
          describeNode(methods.processInstruction);
          break;
        case 'response':
          describeNode('200/201/500');
          break;
      }
    }

    $(document).ready(function() {

      //load content from qs  
      var capabilityName = urlParam('name');

      $('#headingCapability').html('Capability : ' + capabilityName);
      
      api('GET', 'admin/instructionType/' + capabilityName, null, function(err, instructionType) {

        $('#capabilitySchema').html('<div><h2>' + instructionType.description + '</h2><strong>' + instructionType.name + '</strong> inputs<br/><br/><pre><code>' + JSON.stringify(instructionType.schema.request, null, 2) + '</code></pre></div>');
  
        methods.authenticate = instructionType.authenticate;
        methods.validateRequest = instructionType.validateRequest;
        methods.authorize = instructionType.authorize;
        methods.processInstruction = instructionType.processInstruction;

        var code = 'newRequest=>start: new request|web:>javascript:clickNode("newRequest")\n' + 
                'identify=>operation: identify requester:>javascript:clickNode("identify")\n' +
                'validate=>operation: validate request:>javascript:clickNode("validate")\n' +
                'isValid=>condition: is valid?|info:>javascript:clickNode("isValid")\n' +
                'badRequest=>end: response|web:>javascript:clickNode("badRequest")\n' +
                'authorize=>operation: authorize:>javascript:clickNode("authorize")\n' +
                'isAuthorized=>condition: authorized?|info:>javascript:clickNode("isAuthorized")\n' +
                'unauthorizedRequest=>end: response|web:>javascript:clickNode("unauthorizedRequest")\n' +
                'operate=>operation: operate/process:>javascript:clickNode("operate")\n' +
                'response=>end: response|web:>javascript:clickNode("response")\n' + 
                '\n' +
                'newRequest(right)' +
                (instructionType.authenticateChanged ? '->identify' : '') +
                (instructionType.validateRequestChanged ? '->validate->isValid\nisValid(no)->badRequest\nisValid(yes)' : '') +
                (instructionType.authorizeChanged ? '->authorize->isAuthorized\nisAuthorized(no)->unauthorizedRequest\nisAuthorized(yes)' : '') +
                (instructionType.processInstructionChanged ? '->operate(right)' : '') + 
                '->response';

        $('#chart')
          .html(code)
          .flowChart({
            'line-color': '#c0c0c0',
            'line-width': 1,
            'flowstate' : {
              'web' : { 'fill' : '#c0c0c0', 'font-size' : 12 },
              'info' : { 'fill' : '#f0f0f0', 'font-size' : 12 },
              'ifektri' : {'fill' : 'yellow', 'font-color' : 'red', 'font-weight' : 'bold' },
              'processor' : { 'fill' : '#FFFF99' }
            }
          })
          .show()
          .click(function(e) {

            var target = $(event.target);
            var targetId = target.attr('id');

            if (!targetId) {
              target = $(event.target.parentNode);
              targetId = (target.attr('id') || 'noIdX').slice(0, -1);    //remove last "char"
            }
        
            var $a = $(target[0].parentNode);

            if ($a.is('a') && !$a.data('pp')) {     //&& $a.children('text').length > 0 

              $a.popover({
                trigger: 'focus',
                //placement: 'right',
                html : true, 
                container: 'body',
                content: function() {
                  var stepDescription;
                  switch (targetId) {
                    case 'newRequest':
                      stepDescription = 'A new ifektri request arrives';
                      break;
                    case 'identify':
                      stepDescription = methods.authenticate;
                      break;
                    case 'validate':
                      stepDescription = methods.validateRequest;
                      break;
                    case 'isValid':
                      stepDescription = 'if an invalid request was sent';
                      break;
                    case 'badRequest':
                      stepDescription = '400/404/503';
                      break;
                    case 'authorize':
                      stepDescription = methods.authorize;
                      break;
                    case 'isAuthorized':
                      stepDescription = 'if requester is allowed to call this ability';
                      break;
                    case 'unauthorizedRequest':
                      stepDescription = '401';
                      break;
                    case 'operate':
                      stepDescription = methods.processInstruction;
                      break;
                    case 'response':
                      stepDescription = '200/201/500';
                      break;
                    default:
                      stepDescription = ':(';
                      break;
                  }

                  var $temp = $('<code><pre>&nbsp;&nbsp;' + stepDescription.replace('\n', '<br />') + '</pre></code>');
                  hljs.highlightBlock($temp[0]);
                  return $temp.html();
                },
                title: 'your code...'
              });

              $a
                .data('pp', 'pp')
                //.on("show.bs.popover", function() {
                //  $($(this).data("bs.popover").getTipElement()).css("max-width", "405px");
                //})
                $a.popover('show');
            }
          });
      });
    }); 
    </script>
  </body>
</html>

<!--

<h1 id="headingCapability" class="mt-4">Capability</h1>
<div class="card mb-4">
    <div class="card-header">Usage: inputs
      string
      data-name
    </div>
    <div class="card-body">
        sss
    </div>
    <div class="card-footer">
        aaa
    </div>
</div>
<div class="card mb-4">
    <div class="card-body" id="explainCapability"></div>
</div>
<script>

//get queryString param by name
var urlParam = function(name) {
  var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
  if (results == null) {
    return 0;
  }
  return results[1] || 0;
}

//load content from qs  
var capabilityName = urlParam('name');

$('#headingCapability').html('Capability : ' + capabilityName);


api('GET', 'admin/instructionType/' + capabilityName, null, function(err, capability) {

  console.log(capability);
  return ;

//$('<div><strong>' + processorDescription.name + '</strong> inputs<br/><br/><pre><code>' + JSON.stringify(processorDescription.schema.request, null, 2) + '</code></pre><br/>see <a href=#" id="more">more</a></div>')
  
  if (err || !processors || typeof processors === 'undefined') {
    return alert('sorry that didn\'t work. in a perfect world the endpoint should have returned relevant/expected results.\n\nan error occurred "' + (err || 'No processors found') + '"');
  }

    var $rowCapability = $('<tr><td>' + processor.id + '</td><td><a href="#" class="capabilityName">' + processor.name + '</a>&nbsp;<a href="#" data-toggle="popover" class="describeCapability" data-name="' + processor.name + '"><i class="fas fa-question"></i></a></td><td>' + processor.description + '</td><td>' + (processor.enabled === 1 ? '<i class="fas fa-check">' : '<i class="fas fa-times">') + '</td></tr>');

    $('#tableBodyCapabilities').append($rowCapability);

    $rowCapability.click(function(e) {

      var processorName = $(this).children('td:nth-child(2)').children('a').html();
      e.preventDefault();
      // describeCapability(processorName, function(err, capabilityDescription) {
      //   $('#explainCapability').replaceWith(capabilityDescription);
      // });
      $.get('/info/?type=' + processorName, function(explained) {
       $('#explainCapability').replaceWith(explained);
      });
    });


});
</script>
  
-->